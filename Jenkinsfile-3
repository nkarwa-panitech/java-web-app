pipeline {
  agent { label 'node01' }
  options {
    buildDiscarder(logRotator(numToKeepStr: '5'))
  }
  tools{
      maven '3.9.6'
   }
  stages {
    stage ('Build & JUnit Test') {
            steps {
                sh 'mvn install' 
            }
            post {
               success {
                    junit 'target/surefire-reports/**/*.xml'
                }   
            }
        }
    stage('SonarQube Analysis'){
            steps{
                withSonarQubeEnv('sonar') {
                        sh "mvn sonar:sonar"
                }
                timeout(time: 1, unit: 'HOURS') {
                      def qg = waitForQualityGate()
                      if (qg.status != 'OK') {
                           error "Pipeline aborted due to quality gate failure: ${qg.status}"
                      }
                    }
            }
        }
  }
}
